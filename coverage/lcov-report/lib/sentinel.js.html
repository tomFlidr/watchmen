<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/sentinel.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header medium">
    <h1>Code coverage report for <span class="entity">lib/sentinel.js</span></h1>
    <h2>
        Statements: <span class="metric">67.65% <small>(46 / 68)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">55% <small>(11 / 20)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">61.11% <small>(11 / 18)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">67.65% <small>(46 / 68)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">lib/</a> &#187; sentinel.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">10</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var _ = require('lodash');
var debug = require('debug')('sentinel');
&nbsp;
/**
 * Watches for changes in services to restart them when they change.
 */
&nbsp;
function Sentinel(storage, watchmen, options) {
  this.options = options || {};
  this.storage = storage;
  this.watchmen = watchmen;
}
&nbsp;
exports = module.exports = Sentinel;
&nbsp;
var DEFAULT_INTERVAL = 5000;
var FIELDS_WHICH_MODIFICATION_TRIGGER_SERVICE_RESTART = [
  'name',
  'interval',
  'failureInterval',
  'port',
  'url',
  'timeout',
  'alertTo',
  'pingServiceName',
  'pingServiceOptions',
  'warningThreshold'
];
var timeoutId = null;
&nbsp;
Sentinel.prototype._findAdded = function (databaseServices, runningServices) {
  var added = [];
  databaseServices.forEach(function (s) {
    if (!_.find(runningServices, function (rs) {
          return rs.id == s.id;
        })) {
      added.push(s);
    }
  });
  return added;
};
&nbsp;
Sentinel.prototype._findRemoved = function (databaseServices, runningServices) {
  var removed = [];
  runningServices.forEach(function (runningService) {
    if (!_.find(databaseServices, function (s) {
          return s.id == runningService.id;
        })) {
      removed.push(runningService);
    }
  });
  return removed;
};
&nbsp;
function propertyModified(propDb, propService) {
  return JSON.stringify(propDb) !== JSON.stringify(propService);
}
&nbsp;
Sentinel.prototype._findModified = function (databaseServices, runningServices) {
  var modified = [];
  runningServices.forEach(function (runningService) {
    var dbService = _.find(databaseServices, function (rs) {
      return rs.id == runningService.id;
    });
    <span class="missing-if-branch" title="else path not taken" >E</span>if (dbService) {
      for (var key in dbService) {
        if (FIELDS_WHICH_MODIFICATION_TRIGGER_SERVICE_RESTART.indexOf(key) &gt; -1) {
          if (propertyModified(dbService[key], runningService[key])) {
&nbsp;
            debug('property ' + key + ' from service ' + dbService.name + ' changed.');
            debug('db:');
            debug(dbService[key]);
            debug('running service:');
            debug(runningService[key]);
&nbsp;
            modified.push(dbService);
            break;
          }
        }
        else {
          debug('detected changed in field ' + key + '. Ignored');
        }
      }
    }
  });
  return modified;
};
&nbsp;
Sentinel.prototype._tick = <span class="fstat-no" title="function not covered" >function () {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  this.storage.getServices({}, <span class="fstat-no" title="function not covered" >function (err, services) {</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var newServices = self._findAdded(services, self.watchmen.services);</span>
<span class="cstat-no" title="statement not covered" >    if (newServices.length) {</span>
<span class="cstat-no" title="statement not covered" >      newServices.forEach(<span class="fstat-no" title="function not covered" >function (service) {</span></span>
<span class="cstat-no" title="statement not covered" >        console.log('service added: ', service.name);</span>
<span class="cstat-no" title="statement not covered" >        self.watchmen.addService(service);</span>
      });
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    var removedServices = self._findRemoved(services, self.watchmen.services);</span>
<span class="cstat-no" title="statement not covered" >    if (removedServices.length) {</span>
<span class="cstat-no" title="statement not covered" >      removedServices.forEach(<span class="fstat-no" title="function not covered" >function (s) {</span></span>
<span class="cstat-no" title="statement not covered" >        self.watchmen.removeService(s.id);</span>
<span class="cstat-no" title="statement not covered" >        console.log('service removed: ', s.name);</span>
      });
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    var modifiedServices = self._findModified(services, self.watchmen.services);</span>
<span class="cstat-no" title="statement not covered" >    if (modifiedServices.length) {</span>
<span class="cstat-no" title="statement not covered" >      modifiedServices.forEach(<span class="fstat-no" title="function not covered" >function (s) {</span></span>
<span class="cstat-no" title="statement not covered" >        self.watchmen.removeService(s.id);</span>
<span class="cstat-no" title="statement not covered" >        self.watchmen.addService(s);</span>
<span class="cstat-no" title="statement not covered" >        console.log('changes detected in service: ', s.name, '. Restarting...');</span>
      });
    }
  });
};
&nbsp;
Sentinel.prototype.watch = <span class="fstat-no" title="function not covered" >function () {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  clearInterval(timeoutId);</span>
<span class="cstat-no" title="statement not covered" >  timeoutId = setInterval(<span class="fstat-no" title="function not covered" >function () {</span></span>
<span class="cstat-no" title="statement not covered" >    self._tick();</span>
  }, this.options.interval || DEFAULT_INTERVAL);
};
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Jul 04 2015 13:46:27 GMT+0200 (CEST)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
